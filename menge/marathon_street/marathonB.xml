<?xml version="1.0"?>

<BFSM>

	<!-- ==================== Goals ==================== -->

	<!-- Top Street Goals -->
	<GoalSet id="0">
		<Goal type="circle" id="0" x="20" y="212" radius="0.5"/>
		<Goal type="circle" id="1" x="40" y="212" radius="0.5"/>
		<Goal type="circle" id="2" x="60" y="212" radius="0.5"/>
		<Goal type="circle" id="3" x="80" y="212" radius="0.5"/>
		<Goal type="circle" id="4" x="100" y="212" radius="0.5"/>
		<Goal type="circle" id="5" x="120" y="212" radius="0.5"/>
		<Goal type="circle" id="6" x="140" y="212" radius="0.5"/>
		<Goal type="circle" id="7" x="160" y="212" radius="0.5"/>
		<Goal type="circle" id="8" x="180" y="212" radius="0.5"/>
		<Goal type="circle" id="9" x="200" y="212" radius="0.5"/>
		<Goal type="circle" id="10" x="220" y="212" radius="0.5"/>
		<Goal type="circle" id="11" x="240" y="212" radius="0.5"/>
		<Goal type="circle" id="12" x="260" y="212" radius="0.5"/>
		<Goal type="circle" id="13" x="280" y="212" radius="0.5"/>
		<Goal type="circle" id="14" x="300" y="212" radius="0.5"/>
		<Goal type="circle" id="15" x="320" y="212" radius="0.5"/>
		<Goal type="circle" id="16" x="340" y="212" radius="0.5"/>
		<Goal type="circle" id="17" x="360" y="212" radius="0.5"/>
		<Goal type="circle" id="18" x="380" y="212" radius="0.5"/>
		<Goal type="circle" id="19" x="400" y="212" radius="0.5"/>
		<Goal type="circle" id="20" x="420" y="212" radius="0.5"/>
		<Goal type="circle" id="21" x="440" y="212" radius="0.5"/>
		<Goal type="circle" id="22" x="460" y="212" radius="0.5"/>
		<Goal type="circle" id="23" x="480" y="212" radius="0.5"/>
		<Goal type="circle" id="24" x="500" y="212" radius="0.5"/>
		<Goal type="circle" id="25" x="520" y="212" radius="0.5"/>
		<Goal type="circle" id="26" x="540" y="212" radius="0.5"/>
		<Goal type="circle" id="27" x="560" y="212" radius="0.5"/>
		<Goal type="circle" id="28" x="580" y="212" radius="0.5"/>
		<Goal type="circle" id="29" x="600" y="212" radius="0.5"/>
		<Goal type="circle" id="30" x="620" y="212" radius="0.5"/>
		<Goal type="circle" id="31" x="640" y="212" radius="0.5"/>
		<Goal type="circle" id="32" x="660" y="212" radius="0.5"/>
		<Goal type="circle" id="33" x="680" y="212" radius="0.5"/>
		<Goal type="circle" id="34" x="700" y="212" radius="0.5"/>
		<Goal type="circle" id="35" x="720" y="212" radius="0.5"/>
		<Goal type="circle" id="36" x="740" y="212" radius="0.5"/>
		<Goal type="circle" id="37" x="760" y="212" radius="0.5"/>
		<Goal type="circle" id="38" x="780" y="212" radius="0.5"/>
		<Goal type="circle" id="39" x="800" y="212" radius="0.5"/>
		<Goal type="circle" id="40" x="820" y="212" radius="0.5"/>
		<Goal type="circle" id="41" x="840" y="212" radius="0.5"/>
		<Goal type="circle" id="42" x="860" y="212" radius="0.5"/>
		<Goal type="circle" id="43" x="880" y="212" radius="0.5"/>
		<Goal type="circle" id="44" x="900" y="212" radius="0.5"/>
		<Goal type="circle" id="45" x="920" y="212" radius="0.5"/>
		<Goal type="circle" id="46" x="940" y="212" radius="0.5"/>
		<Goal type="circle" id="47" x="960" y="212" radius="0.5"/>
		<Goal type="circle" id="48" x="980" y="212" radius="0.5"/>
		<Goal type="circle" id="49" x="1000" y="212" radius="0.5"/>
		<Goal type="circle" id="50" x="1020" y="212" radius="0.5"/>
		<Goal type="circle" id="51" x="1040" y="212" radius="0.5"/>
		<Goal type="circle" id="52" x="1060" y="212" radius="0.5"/>
		<Goal type="circle" id="53" x="1080" y="212" radius="0.5"/>
		<Goal type="circle" id="54" x="1100" y="212" radius="0.5"/>
		<Goal type="circle" id="55" x="1120" y="212" radius="0.5"/>
		<Goal type="circle" id="56" x="1140" y="212" radius="0.5"/>
		<Goal type="circle" id="57" x="1160" y="212" radius="0.5"/>
		<Goal type="circle" id="58" x="1180" y="212" radius="0.5"/>
		<Goal type="circle" id="59" x="1200" y="212" radius="0.5"/>
		<Goal type="circle" id="60" x="1220" y="212" radius="0.5"/>
		<Goal type="circle" id="61" x="1240" y="212" radius="0.5"/>
		<Goal type="circle" id="62" x="1260" y="212" radius="0.5"/>
		<Goal type="circle" id="63" x="1280" y="212" radius="0.5"/>
		<Goal type="circle" id="64" x="1300" y="212" radius="0.5"/>
		<Goal type="circle" id="65" x="1320" y="212" radius="0.5"/>
		<Goal type="circle" id="66" x="1340" y="212" radius="0.5"/>
		<Goal type="circle" id="67" x="1360" y="212" radius="0.5"/>
		<Goal type="circle" id="68" x="1380" y="212" radius="0.5"/>
		<Goal type="circle" id="69" x="1400" y="212" radius="0.5"/>
		<Goal type="circle" id="70" x="1420" y="212" radius="0.5"/>
		<Goal type="circle" id="71" x="1440" y="212" radius="0.5"/>
		<Goal type="circle" id="72" x="1460" y="212" radius="0.5"/>
		<Goal type="circle" id="73" x="1480" y="212" radius="0.5"/>
		<Goal type="circle" id="74" x="1500" y="212" radius="0.5"/>
		<Goal type="circle" id="75" x="1520" y="212" radius="0.5"/>
		<Goal type="circle" id="76" x="1540" y="212" radius="0.5"/>
		<Goal type="circle" id="77" x="1560" y="212" radius="0.5"/>
		<Goal type="circle" id="78" x="1580" y="212" radius="0.5"/>
	</GoalSet>

	<!-- Bottom Street Goals -->
	<GoalSet id="1">
		<Goal type="circle" id="0" x="20" y="148" radius="0.5"/>
		<Goal type="circle" id="1" x="40" y="148" radius="0.5"/>
		<Goal type="circle" id="2" x="60" y="148" radius="0.5"/>
		<Goal type="circle" id="3" x="80" y="148" radius="0.5"/>
		<Goal type="circle" id="4" x="100" y="148" radius="0.5"/>
		<Goal type="circle" id="5" x="120" y="148" radius="0.5"/>
		<Goal type="circle" id="6" x="140" y="148" radius="0.5"/>
		<Goal type="circle" id="7" x="160" y="148" radius="0.5"/>
		<Goal type="circle" id="8" x="180" y="148" radius="0.5"/>
		<Goal type="circle" id="9" x="200" y="148" radius="0.5"/>
		<Goal type="circle" id="10" x="220" y="148" radius="0.5"/>
		<Goal type="circle" id="11" x="240" y="148" radius="0.5"/>
		<Goal type="circle" id="12" x="260" y="148" radius="0.5"/>
		<Goal type="circle" id="13" x="280" y="148" radius="0.5"/>
		<Goal type="circle" id="14" x="300" y="148" radius="0.5"/>
		<Goal type="circle" id="15" x="320" y="148" radius="0.5"/>
		<Goal type="circle" id="16" x="340" y="148" radius="0.5"/>
		<Goal type="circle" id="17" x="360" y="148" radius="0.5"/>
		<Goal type="circle" id="18" x="380" y="148" radius="0.5"/>
		<Goal type="circle" id="19" x="400" y="148" radius="0.5"/>
		<Goal type="circle" id="20" x="420" y="148" radius="0.5"/>
		<Goal type="circle" id="21" x="440" y="148" radius="0.5"/>
		<Goal type="circle" id="22" x="460" y="148" radius="0.5"/>
		<Goal type="circle" id="23" x="480" y="148" radius="0.5"/>
		<Goal type="circle" id="24" x="500" y="148" radius="0.5"/>
		<Goal type="circle" id="25" x="520" y="148" radius="0.5"/>
		<Goal type="circle" id="26" x="540" y="148" radius="0.5"/>
		<Goal type="circle" id="27" x="560" y="148" radius="0.5"/>
		<Goal type="circle" id="28" x="580" y="148" radius="0.5"/>
		<Goal type="circle" id="29" x="600" y="148" radius="0.5"/>
		<Goal type="circle" id="30" x="620" y="148" radius="0.5"/>
		<Goal type="circle" id="31" x="640" y="148" radius="0.5"/>
		<Goal type="circle" id="32" x="660" y="148" radius="0.5"/>
		<Goal type="circle" id="33" x="680" y="148" radius="0.5"/>
		<Goal type="circle" id="34" x="700" y="148" radius="0.5"/>
		<Goal type="circle" id="35" x="720" y="148" radius="0.5"/>
		<Goal type="circle" id="36" x="740" y="148" radius="0.5"/>
		<Goal type="circle" id="37" x="760" y="148" radius="0.5"/>
		<Goal type="circle" id="38" x="780" y="148" radius="0.5"/>
		<Goal type="circle" id="39" x="800" y="148" radius="0.5"/>
		<Goal type="circle" id="40" x="820" y="148" radius="0.5"/>
		<Goal type="circle" id="41" x="840" y="148" radius="0.5"/>
		<Goal type="circle" id="42" x="860" y="148" radius="0.5"/>
		<Goal type="circle" id="43" x="880" y="148" radius="0.5"/>
		<Goal type="circle" id="44" x="900" y="148" radius="0.5"/>
		<Goal type="circle" id="45" x="920" y="148" radius="0.5"/>
		<Goal type="circle" id="46" x="940" y="148" radius="0.5"/>
		<Goal type="circle" id="47" x="960" y="148" radius="0.5"/>
		<Goal type="circle" id="48" x="980" y="148" radius="0.5"/>
		<Goal type="circle" id="49" x="1000" y="148" radius="0.5"/>
		<Goal type="circle" id="50" x="1020" y="148" radius="0.5"/>
		<Goal type="circle" id="51" x="1040" y="148" radius="0.5"/>
		<Goal type="circle" id="52" x="1060" y="148" radius="0.5"/>
		<Goal type="circle" id="53" x="1080" y="148" radius="0.5"/>
		<Goal type="circle" id="54" x="1100" y="148" radius="0.5"/>
		<Goal type="circle" id="55" x="1120" y="148" radius="0.5"/>
		<Goal type="circle" id="56" x="1140" y="148" radius="0.5"/>
		<Goal type="circle" id="57" x="1160" y="148" radius="0.5"/>
		<Goal type="circle" id="58" x="1180" y="148" radius="0.5"/>
		<Goal type="circle" id="59" x="1200" y="148" radius="0.5"/>
		<Goal type="circle" id="60" x="1220" y="148" radius="0.5"/>
		<Goal type="circle" id="61" x="1240" y="148" radius="0.5"/>
		<Goal type="circle" id="62" x="1260" y="148" radius="0.5"/>
		<Goal type="circle" id="63" x="1280" y="148" radius="0.5"/>
		<Goal type="circle" id="64" x="1300" y="148" radius="0.5"/>
		<Goal type="circle" id="65" x="1320" y="148" radius="0.5"/>
		<Goal type="circle" id="66" x="1340" y="148" radius="0.5"/>
		<Goal type="circle" id="67" x="1360" y="148" radius="0.5"/>
		<Goal type="circle" id="68" x="1380" y="148" radius="0.5"/>
		<Goal type="circle" id="69" x="1400" y="148" radius="0.5"/>
		<Goal type="circle" id="70" x="1420" y="148" radius="0.5"/>
		<Goal type="circle" id="71" x="1440" y="148" radius="0.5"/>
		<Goal type="circle" id="72" x="1460" y="148" radius="0.5"/>
		<Goal type="circle" id="73" x="1480" y="148" radius="0.5"/>
		<Goal type="circle" id="74" x="1500" y="148" radius="0.5"/>
		<Goal type="circle" id="75" x="1520" y="148" radius="0.5"/>
		<Goal type="circle" id="76" x="1540" y="148" radius="0.5"/>
		<Goal type="circle" id="77" x="1560" y="148" radius="0.5"/>
		<Goal type="circle" id="78" x="1580" y="148" radius="0.5"/>
	</GoalSet>

	<!-- Top Entrances -->
	<GoalSet id="2">
		<Goal type="circle" id="0" x="105" y="298" radius="0.5"/>
		<Goal type="circle" id="1" x="164" y="298" radius="0.5"/>
		<Goal type="circle" id="2" x="557" y="298" radius="0.5"/>
		<Goal type="circle" id="3" x="1135" y="298" radius="0.5"/>
		<Goal type="circle" id="4" x="600" y="298" radius="0.5"/>
		<Goal type="circle" id="5" x="729" y="298" radius="0.5"/>
		<Goal type="circle" id="6" x="915" y="298" radius="0.5"/>
	</GoalSet>

	<!-- Bottom Entrances -->
	<GoalSet id="3">
		<Goal type="circle" id="0" x="160" y="2" radius="0.5"/>
		<Goal type="circle" id="1" x="194" y="2" radius="0.5"/>
		<Goal type="circle" id="2" x="600" y="2" radius="0.5"/>
		<Goal type="circle" id="3" x="848" y="2" radius="0.5"/>
		<Goal type="circle" id="4" x="1088" y="2" radius="0.5"/>
		<Goal type="circle" id="5" x="1130" y="2" radius="0.5"/>
		<Goal type="circle" id="6" x="1310" y="2" radius="0.5"/>
	</GoalSet>

	<!-- Top Bathrooms -->
	<GoalSet id="4">
		<Goal type="circle" id="0" x="200" y="260" radius="0.5"/>
		<Goal type="circle" id="1" x="325" y="260" radius="0.5"/>
		<Goal type="circle" id="2" x="410" y="260" radius="0.5"/>
		<Goal type="circle" id="3" x="1075" y="260" radius="0.5"/>
	</GoalSet>

	<!-- Bottom Bathrooms -->
	<GoalSet id="5">
		<Goal type="circle" id="0" x="310" y="25" radius="0.5"/>
		<Goal type="circle" id="1" x="485" y="25" radius="0.5"/>
		<Goal type="circle" id="2" x="846" y="60" radius="0.5"/>
		<Goal type="circle" id="3" x="1130" y="60" radius="0.5"/>
	</GoalSet>


	<!-- ==================== States ==================== -->

	<!-- Start Behavior -->
	<State name="StartTop" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>
	<State name="StartBottom" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>

	<!-- Inside Top -->
	<State name="InsideTop1" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="105" y_value="298" />
	</State>
	<State name="InsideTop2" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="164" y_value="298" />
	</State>
	<State name="InsideTop3" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="557" y_value="298" />
	</State>
	<State name="InsideTop4" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="1135" y_value="298" />
	</State>
	<State name="InsideTop5" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="600" y_value="298" />
	</State>
	<State name="InsideTop6" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="729" y_value="298" />
	</State>
	<State name="InsideTop7" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="915" y_value="298" />
	</State>

	<!-- Inside Bottom -->
	<State name="InsideBottom1" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="160" y_value="2" />
	</State>
	<State name="InsideBottom2" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="194" y_value="2" />
	</State>
	<State name="InsideBottom3" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="600" y_value="2" />
	</State>
	<State name="InsideBottom4" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="848" y_value="2" />
	</State>
	<State name="InsideBottom5" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="1088" y_value="2" />
	</State>
	<State name="InsideBottom6" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="1130" y_value="2" />
	</State>
	<State name="InsideBottom7" final="0">
		<GoalSelector type="identity"/>
		<VelComponent type="zero"/>
		<Action type="teleport" dist="c" x_value="1310" y_value="2" />
	</State>

	<!-- Wait Start -->
	<State name="WaitStartTop" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>
	<State name="WaitStartBottom" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>

	

	<!-- Go Bathroom -->
	<State name="GoBathroomTop" final="0">
		<GoalSelector type="random" goal_set="4" />
		<VelComponent type="road_map" file_name="marathon_street_map.txt" />
	</State>
	<State name="GoBathroomBottom" final="0">
		<GoalSelector type="random" goal_set="5" />
		<VelComponent type="road_map" file_name="marathon_street_map.txt" />
	</State>

	<!-- Wait Bathroom -->
	<State name="WaitBathroomTop" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>
	<State name="WaitBathroomBottom" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>

	<!-- Go Goal -->
	<State name="GoGoalTop" final="0">
		<GoalSelector type="random" goal_set="0" />
		<VelComponent type="road_map" file_name="marathon_street_map.txt" />
	</State>
	<State name="GoGoalBottom" final="0">
		<GoalSelector type="random" goal_set="1" />
		<VelComponent type="road_map" file_name="marathon_street_map.txt" />
	</State>

	<!-- At Goal -->
	<State name="AtGoalTop" final="1">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>
	<State name="AtGoalBottom" final="1">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>

	<!-- Wait Goal -->
	<State name="WaitGoalTop" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>
	<State name="WaitGoalBottom" final="0">
		<GoalSelector type="identity" />
		<VelComponent type="zero" />
	</State>

	<!-- ==================== Transitions ==================== -->

	<!-- Start Behavior to Wait Start (Wait 0-100 Steps) --> 
	<Transition from="StartTop" to="WaitStartTop">
		<Condition type="timer" dist="u" min="0" max="100" per_agent="1" />
	</Transition>
	<Transition from="StartBottom" to="WaitStartBottom">
		<Condition type="timer" dist="u" min="0" max="100" per_agent="1" />
	</Transition>

	<!-- Spawn at Random Entrance -->
	<Transition from="WaitStartTop">
		<Condition type="auto" />
		<Target type="prob">
			<State name="InsideTop1" weight="1"/>
			<State name="InsideTop2" weight="1"/>
			<State name="InsideTop3" weight="1"/>
			<State name="InsideTop4" weight="1"/>
			<State name="InsideTop5" weight="1"/>
			<State name="InsideTop6" weight="1"/>
			<State name="InsideTop7" weight="1"/>
		</Target>
	</Transition>
	<Transition from="WaitStartBottom">
		<Condition type="auto" />
		<Target type="prob">
			<State name="InsideBottom1" weight="1"/>
			<State name="InsideBottom2" weight="1"/>
			<State name="InsideBottom3" weight="1"/>
			<State name="InsideBottom4" weight="1"/>
			<State name="InsideBottom5" weight="1"/>
			<State name="InsideBottom6" weight="1"/>
			<State name="InsideBottom7" weight="1"/>
		</Target>
	</Transition>

	<!-- Inside to Bathroom OR Goal (1% chance to stop by bathroom) -->
	<Transition from="InsideTop1,InsideTop2,InsideTop3,InsideTop4,InsideTop5,InsideTop6,InsideTop7">
		<Condition type="auto" />
		<Target type="prob">
			<State name="GoBathroomTop" weight="0.01"/>
			<State name="GoGoalTop" weight="0.99"/>
		</Target>
	</Transition>
	<Transition from="InsideBottom1,InsideBottom2,InsideBottom3,InsideBottom4,InsideBottom5,InsideBottom6,InsideBottom7">
		<Condition type="auto" />
		<Target type="prob">
			<State name="GoBathroomBottom" weight="0.01"/>
			<State name="GoGoalBottom" weight="0.99"/>
		</Target>
	</Transition>

	<!-- Arrive at Goal -->
	<Transition from="GoGoalTop" to="AtGoalTop">
		<Condition type="goal_reached" distance="1" />
	</Transition>
	<Transition from="GoGoalBottom" to="AtGoalBottom">
		<Condition type="goal_reached" distance="1" />
	</Transition>

	<!-- Wait at goal -->
	<Transition from="AtGoalTop" to="WaitGoalTop">
		<Condition type="timer" dist="u" min="0" max="100" per_agent="1" />
	</Transition>
	<Transition from="AtGoalBottom" to="WaitGoalBottom">
		<Condition type="timer" dist="u" min="0" max="100" per_agent="1" />
	</Transition>

	<!-- Decide to go to the bathroom again after waiting -->
	<Transition from="WaitGoalTop">
		<Condition type="auto" />
		<Target type="prob">
			<State name="GoBathroomTop" weight="0.01"/>
			<State name="AtGoalTop" weight="0.99"/>
		</Target>
	</Transition>
	<Transition from="WaitGoalBottom">
		<Condition type="auto" />
		<Target type="prob">
			<State name="GoBathroomBottom" weight="0.01"/>
			<State name="AtGoalBottom" weight="0.99"/>
		</Target>
	</Transition>

	<!-- Arrive at Bathroom -->
	<Transition from="GoBathroomTop" to="WaitBathroomTop">
		<Condition type="goal_reached" distance="1" />
	</Transition>
	<Transition from="GoBathroomBottom" to="WaitBathroomBottom">
		<Condition type="goal_reached" distance="1" />
	</Transition>

	<!-- Wait Bathroom to Go Goal (Wait 0-100 Steps) -->
	<Transition from="WaitBathroomTop" to="GoGoalTop">
		<Condition type="timer" dist="u" min="0" max="100" per_agent="1" />
	</Transition>
	<Transition from="WaitBathroomBottom" to="GoGoalBottom">
		<Condition type="timer" dist="u" min="0" max="100" per_agent="1" />
	</Transition>

	



</BFSM>
